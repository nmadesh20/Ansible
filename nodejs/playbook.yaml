---
- hosts: rhel
  become: true
  pre_tasks:
    - name: Import Remi GPG key.
      rpm_key:
        key: "http://rpms.remirepo.net/RPM-GPG-KEY-remi"
        state: present 
    - name: Install remi repo.
      dnf:
        name: "https://rpms.remirepo.net/enterprise/remi-release-8.rpm"
        state: present 
    - name: Install EPEL repo. 
      dnf: 
        name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm 
        state: present 
    - name: Ensure firewalld is stopped 
      service:
        name: firewalld
        state: stopped
  roles:
    - nodejs
  tasks:
    - name: Ensure Node.js app folder exists.
      file: "path= {{ node_apps_location }} state= directory"
    - name: Copy example Node.js app to server.
      copy: "src= app dest= {{ node_apps_location }}"
    - name: Install app dependencies defined in package.json.
      npm: path= {{ node_apps_location }}/app
    - name: Check list of running Node.js apps.
      command: forever list
      register: forever_list
      changed_when: false
    - name: Start example Node.js apps.
      command: "forever start {{ node_apps_location }}/app/app.js"
      when: "forever_list.stdout.find(node_apps_location + '/app/app.js') == -1"